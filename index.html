<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Biodiversity Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
    }
    #map {
      height: 100vh;
      width: 75%;
    }
    #sidebar {
      width: 25%;
      height: 100vh;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      border-left: 1px solid #ccc;
      font-family: sans-serif;
    }
    h2 {
      margin-top: 0;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
    .leaflet-control-layers-expanded {
      width: auto !important;
      max-height: none !important;
      display: block !important;
    }
    #taxa-filter {
      width: 100%;
      margin-bottom: 10px;
    }
    #download-btn {
      margin-top: 10px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h2>Site Info</h2>
    <select id="taxa-filter">
      <option value="all">All Taxa</option>
    </select>
    <div id="zone-details">Click a zone to see details</div>
    <canvas id="barChart"></canvas>
    <canvas id="lineChart"></canvas>
    <div id="species-list"></div>
    <button id="download-btn">Download Filtered Data</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([-37.58, 145.2], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let barChart, lineChart, detections = [], latestSpeciesData = {}, filteredDetections = [], selectedZoneId = null, selectedIsBlock = false;

    const boundaryStyle = {
      color: 'black',
      weight: 2,
      fillOpacity: 0,
      interactive: false
    };

    fetch('nillumbik_boundary.geojson')
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, { style: boundaryStyle }).addTo(map);
      });

    var fiveZoneLayer = L.layerGroup();
    var thirtyZoneLayer = L.layerGroup();

    function updateSpeciesList(group) {
      const speciesSet = latestSpeciesData[group];
      if (!speciesSet) return;

      const listHTML = [...speciesSet].sort().map(s => `<li>${s}</li>`).join('');
      document.getElementById('species-list').innerHTML = `
        <h4>${group === 'native' ? 'Native' : 'Non-native'} Species List</h4>
        <ul>${listHTML}</ul>
      `;
    }

    function updateCharts(native, nonnative, trendNative, trendNonNative, years) {
      if (barChart) barChart.destroy();
      if (lineChart) lineChart.destroy();

      const ctxBar = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: ['Native', 'Non-native'],
          datasets: [{
            label: 'Species Richness',
            data: [native, nonnative],
            backgroundColor: ['green', 'red']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          onClick: (e, elements) => {
            if (!elements.length) return;
            const idx = elements[0].index;
            updateSpeciesList(idx === 0 ? 'native' : 'nonnative');
          }
        }
      });

      const ctxLine = document.getElementById('lineChart').getContext('2d');
      lineChart = new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            { label: 'Native Richness', data: trendNative, borderColor: 'green', fill: false },
            { label: 'Non-native Richness', data: trendNonNative, borderColor: 'red', fill: false }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } } }
      });
    }

    function showZoneDetails(feature, isBlock = false) {
      const props = feature.properties;
      const zoneId = String(isBlock ? props.block : props.site);
      selectedZoneId = zoneId;
      selectedIsBlock = isBlock;
      filterDetectionsByTaxa();
    }

    function filterDetectionsByTaxa() {
      const selectedTaxa = document.getElementById('taxa-filter').value;

      filteredDetections = detections.filter(d => {
        const matchZone = selectedIsBlock ? String(d.block) === selectedZoneId : String(d.site) === selectedZoneId;
        const matchTaxa = selectedTaxa === 'all' || d.taxa === selectedTaxa;
        return matchZone && matchTaxa;
      });

      const nativeSpecies = new Set();
      const nonNativeSpecies = new Set();
      const trends = {};

      filteredDetections.forEach(d => {
        const isNative = (d.native || '').toLowerCase() === 'native';
        const label = `${d.common_name || ''} (${d.name})`;
        const year = d.year;
        if (!trends[year]) trends[year] = { native: new Set(), nonnative: new Set() };

        if (isNative) {
          nativeSpecies.add(label);
          trends[year].native.add(label);
        } else {
          nonNativeSpecies.add(label);
          trends[year].nonnative.add(label);
        }
      });

      latestSpeciesData = { native: nativeSpecies, nonnative: nonNativeSpecies };

      const years = Object.keys(trends).sort();
      const trendNative = years.map(y => trends[y].native.size);
      const trendNonNative = years.map(y => trends[y].nonnative.size);

      document.getElementById('zone-details').innerHTML = `
        <h3>${selectedZoneId}</h3>
        <p><strong>Filtered Detections:</strong> ${filteredDetections.length}</p>
        <p><strong>Unique Native Species:</strong> ${nativeSpecies.size}</p>
        <p><strong>Unique Non-native Species:</strong> ${nonNativeSpecies.size}</p>
      `;

      updateCharts(nativeSpecies.size, nonNativeSpecies.size, trendNative, trendNonNative, years);
      document.getElementById('species-list').innerHTML = '';
    }

    const blockFiles = ['detections_block_1.json', 'detections_block_2.json', 'detections_block_3.json', 'detections_block_4.json', 'detections_block_5.json'];
    Promise.all(blockFiles.map(f => fetch(f).then(res => res.json()))).then(results => {
      detections = results.flat();
      const taxaSet = new Set(detections.map(d => d.taxa).filter(Boolean));
      const taxaFilter = document.getElementById('taxa-filter');
      taxaSet.forEach(t => {
        const option = document.createElement('option');
        option.value = t;
        option.textContent = t;
        taxaFilter.appendChild(option);
      });
      taxaFilter.addEventListener('change', filterDetectionsByTaxa);
    });

    document.getElementById('download-btn').addEventListener('click', () => {
      if (!filteredDetections.length) return;
      const csvHeader = Object.keys(filteredDetections[0]).join(',');
      const csvRows = filteredDetections.map(obj => Object.values(obj).join(','));
      const blob = new Blob([csvHeader + '\n' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${selectedZoneId}_filtered_data.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    fetch('blocks.geojson')
      .then(response => response.json())
      .then(data => {
        const fiveLayerInstance = L.geoJSON(data, {
          style: { color: 'darkgreen', weight: 1, fillOpacity: 0.3 },
          onEachFeature: function (feature, layer) {
            layer.on({
              mouseover: () => layer.setStyle({ weight: 2, color: 'lime' }),
              mouseout: () => layer.setStyle({ weight: 1, color: 'darkgreen' }),
              click: () => { if (map.hasLayer(fiveZoneLayer)) showZoneDetails(feature, true); }
            });
          }
        });
        fiveZoneLayer.addLayer(fiveLayerInstance);
      });

    fetch('nillumbik_30zones.geojson')
      .then(response => response.json())
      .then(data => {
        const thirtyLayerInstance = L.geoJSON(data, {
          style: { color: 'blue', weight: 0.5, fillOpacity: 0.2 },
          onEachFeature: function (feature, layer) {
            layer.on({
              mouseover: () => layer.setStyle({ weight: 2, color: 'cyan' }),
              mouseout: () => layer.setStyle({ weight: 0.5, color: 'blue' }),
              click: () => { if (!map.hasLayer(fiveZoneLayer)) showZoneDetails(feature); }
            });
          }
        });
        thirtyZoneLayer.addLayer(thirtyLayerInstance);
      });

    const overlayMaps = {
      "5 Zones": fiveZoneLayer,
      "30 Zones": thirtyZoneLayer
    };
    L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);
    fiveZoneLayer.addTo(map);
    thirtyZoneLayer.addTo(map);
  </script>
</body>
</html>
